<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Vendedores</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/navbar.css" />
    <link rel="stylesheet" href="/static/css/scrollbar.css" />
        <!-- <link rel="stylesheet" href="/static/css/vendedores.css" /> -->
    <style>
        :root {
            --color-background-dark: #0a0a10; --color-background-medium: #111827;
            --color-background-light: #1f2937; --color-accent: #4caf91;
            --color-accent-hover: #5cdb95; --color-text-primary: #e5e7eb;
            --color-text-secondary: #9ca3af; --color-highlight: #4caf91;
            --color-border: rgba(76, 175, 145, 0.2); --color-success: #4caf50;
            --color-warning: #ff9800; --color-danger: #f44336; --color-info: #2196f3;
            --color-green-progress: #4caf50; --border-radius-large: 10px; --border-radius-medium: 6px;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background-dark); color: var(--color-text-primary); line-height: 1.7; padding-top: 70px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .page-title { font-size: 2rem; font-weight: 600; color: var(--color-text-primary); margin: 0; }
        .page-title .highlight { color: var(--color-highlight); }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 6px; font-weight: 500; text-decoration: none; transition: all 0.3s ease; border: none; cursor: pointer; }
        .btn-primary { background-color: var(--color-accent); color: var(--color-background-dark); }
        .btn-primary:hover { background-color: var(--color-accent-hover); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(76, 175, 145, 0.3); }
        .btn-secondary { background-color: var(--color-background-light); color: var(--color-text-primary); border: 1px solid var(--color-border); }
        .btn-secondary:hover { background-color: #2a3a4a; border-color: var(--color-accent); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn-info { background-color: var(--color-info); color: white; }
        .btn-info:hover { background-color: #4dabf5; }
        .btn-warning { background-color: var(--color-warning); color: var(--color-background-dark); }
        .btn-warning:hover { background-color: #ffac33; }
        .btn-outline-secondary { background: none; border: 1px solid var(--color-text-secondary); color: var(--color-text-secondary); }
        .btn-outline-secondary:hover { background-color: rgba(156, 163, 175, 0.1); border-color: var(--color-text-primary); color: var(--color-text-primary); }
        .vendedor-main-container {}
        .vendedor-section-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 1.5rem;}
        .header-title-button { display: flex; align-items: center; gap: 15px; }
        .header-title-button h2 { margin: 0; font-size: 1.6rem; display: flex; align-items: center; gap: 10px; }
        .icon-header { color: var(--color-accent); }
        .icon-closer { color: var(--color-info); }
        .seller-filter-container { display: flex; align-items: center; background: var(--color-background-light); border-radius: var(--border-radius-medium); padding: 5px 10px; border: 1px solid var(--color-border); }
        .filter-icon { color: var(--color-text-secondary); margin-right: 8px; }
        #closer-name-filter { background: none; border: none; color: var(--color-text-primary); outline: none; font-size: 0.9rem; padding: 5px;}
        .global-feedback { margin-bottom: 1.5rem; }
        .alert { padding: 15px 20px; border-radius: 6px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .alert-success { background-color: rgba(76, 175, 80, 0.15); color: var(--color-success); border-left: 4px solid var(--color-success); }
        .alert-danger { background-color: rgba(244, 67, 54, 0.15); color: var(--color-danger); border-left: 4px solid var(--color-danger); }
        .alert i { font-size: 1.2rem; }
        .resumen-vendedores-container { background: var(--color-background-medium); border-radius: var(--border-radius-large); border: 1px solid var(--color-border); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25); margin-bottom: 2rem; overflow: hidden; }
        .resumen-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: linear-gradient(to right, rgba(33, 38, 45, 0.6), rgba(22, 27, 34, 0.4)); border-bottom: 1px solid var(--color-border); }
        .resumen-header h3 { margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--color-text-primary); display: inline-flex; align-items: center; gap: 0.7rem; }
        .resumen-header h3 i { color: var(--color-info); }
        .resumen-list-container { transition: max-height 0.3s ease-out; max-height: 1000px; overflow-y: auto; }
        .resumen-list-container.collapsed { max-height: 0; overflow: hidden; padding-top: 0; padding-bottom: 0; border-top: none;}
        .resumen-table { width: 100%; border-collapse: collapse; }
        .resumen-table th, .resumen-table td { padding: 0.8rem 1.2rem; text-align: left; border-bottom: 1px solid var(--color-border); font-size: 0.9rem; vertical-align: middle;}
        .resumen-table th { background-color: var(--color-background-light); font-weight: 600; position: sticky; top: 0; z-index: 1; color: var(--color-text-secondary); text-transform: uppercase; font-size: 0.8rem; }
        .resumen-table tr { background-color: var(--color-background-medium); transition: background-color 0.2s ease; }
        .resumen-table tr:hover { background-color: var(--color-background-light); }
        .resumen-item {}
        .resumen-nombre { font-weight: 500; color: var(--color-text-primary); display: flex; flex-direction: column; }
        .resumen-nombre small { font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.2rem; display: flex; align-items: center; gap: 0.4rem; }
        .resumen-nombre small i { color: var(--color-accent); }
        .mini-progress-container { position: relative; height: 20px; background: rgba(33, 150, 243, 0.1); border-radius: var(--border-radius-medium); overflow: hidden; border: 1px solid rgba(33, 150, 243, 0.2); min-width: 80px;}
        .mini-progress-bar { height: 100%; transition: width 0.3s ease; background-color: var(--color-info); }
        .mini-progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; font-weight: bold; color: #fff; text-shadow: 0 0 2px rgba(0,0,0,0.5); }
        .tag { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; line-height: 1; text-transform: capitalize;}
        .tag-estado-activo { background-color: var(--color-success); color: #fff; }
        .tag-estado-inactivo { background-color: var(--color-text-secondary); color: var(--color-background-dark); }
        .tag-estado-baja { background-color: var(--color-danger); color: #fff; }
        .agendas-col { text-align: center; font-weight: 600; color: var(--color-info);}
        .vendedor-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 2.5rem; }
        .vendedor-card { background: var(--color-background-medium); border-radius: var(--border-radius-large); padding: 1.5rem; border: 1px solid var(--color-border); box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: box-shadow 0.3s ease;}
        .vendedor-card:hover { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .vendedor-card.highlighted { animation: highlight-closer 1.5s ease-out; }
        @keyframes highlight-closer { 50% { box-shadow: 0 0 0 8px rgba(33, 150, 243, 0.3); } }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--color-border); position: relative;}
        .card-header .tag-estado { position: absolute; top: -24px; right: -24px; padding: 5px 10px; border-bottom-left-radius: 8px; border-top-right-radius: 8px;}
        .vendedor-nombre { font-size: 1.3rem; font-weight: 600; color: var(--color-text-primary); margin-bottom: 0.2rem; margin-top: 0;}
        .manager { font-size: 0.8rem; color: var(--color-text-secondary); display: flex; align-items: center; gap: 5px;}
        .card-body { flex-grow: 1; display: flex; flex-direction: column; gap: 1rem; }
        .card-section { }
        .card-section h4 { font-size: 0.9rem; color: var(--color-text-secondary); margin-bottom: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;}
        .card-section h4 i { color: var(--color-accent);}
        .icon-closer { color: var(--color-info); }
        .account-list { list-style: none; padding-left: 0; max-height: 100px; overflow-y: auto; margin: 0; }
        .account-list li { margin-bottom: 5px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .tag-cuenta { background-color: var(--color-background-light); color: var(--color-text-secondary); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;}
        .card-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; }
        .stat-item { background: var(--color-background-light); padding: 10px; border-radius: var(--border-radius-medium); border: 1px solid var(--color-border); }
        .stat-item label { display: block; font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 5px; display: flex; align-items: center; gap: 5px;}
        .stat-item span { font-size: 1rem; font-weight: 600; color: var(--color-text-primary); }
        .stat-item .agendas-col { font-size: 1.2rem; color: var(--color-info);}
        .stat-item small i { margin-left: 5px; color: var(--color-text-secondary); cursor: help;}
        .stat-progress { grid-column: 1 / -1; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 3px; }
        .progress-numbers { color: var(--color-text-secondary); }
        .progress-percentage { font-weight: bold; color: var(--color-text-primary); }
        .progress-bar-container { height: 8px; background-color: rgba(33, 150, 243, 0.2); border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--color-info); border-radius: 4px; transition: width 0.5s ease-out; }
        .notas { font-size: 0.9rem; color: var(--color-text-secondary); background: var(--color-background-light); padding: 10px; border-radius: var(--border-radius-medium); max-height: 80px; overflow-y: auto; border: 1px solid var(--color-border); white-space: pre-wrap;}
        .no-data { font-style: italic; color: var(--color-text-secondary); font-size: 0.9rem; margin-top: 5px;}
        .no-data-global { text-align: center; padding: 2rem; color: var(--color-text-secondary); }
        .card-footer { display: flex; justify-content: flex-end; gap: 10px; padding-top: 1rem; margin-top: 1rem; border-top: 1px solid var(--color-border); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1050; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background-color: var(--color-background-medium); border-radius: var(--border-radius-large); padding: 25px; width: 100%; max-width: 650px; max-height: 90vh; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--color-border); }
        .modal-title { font-size: 1.5rem; font-weight: 600; color: var(--color-accent); margin: 0; }
        .modal-close-btn { background: none; border: none; color: var(--color-text-secondary); font-size: 1.8rem; line-height: 1; cursor: pointer; padding: 0; transition: color 0.3s ease; }
        .modal-close-btn:hover { color: var(--color-text-primary); }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 10px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 1rem;}
        .form-group { margin-bottom: 1rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--color-text-primary); display: flex; align-items: center; gap: 8px;}
        .form-label i { color: var(--color-text-secondary); font-size: 1em; }
        .form-control, select, textarea { width: 100%; padding: 10px 15px; background-color: var(--color-background-light); border: 1px solid var(--color-border); border-radius: var(--border-radius-medium); color: var(--color-text-primary); font-family: 'Poppins', sans-serif; font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .form-control:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 2px rgba(76, 175, 145, 0.3); }
        input[type="date"] { color-scheme: dark; min-height: 44px;}
        textarea { min-height: 80px; resize: vertical; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 15px; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border); }
        .feedback-message { margin-top: 1rem; padding: 10px; border-radius: var(--border-radius-medium); font-size: 0.9rem; text-align: center; display: none; }
        .feedback-message.info { background-color: rgba(33, 150, 243, 0.1); color: var(--color-info); border: 1px solid var(--color-info); display: block;}
        .feedback-message.success { background-color: rgba(76, 175, 80, 0.1); color: var(--color-success); border: 1px solid var(--color-success); display: block;}
        .feedback-message.error { background-color: rgba(244, 67, 54, 0.1); color: var(--color-danger); border: 1px solid var(--color-danger); display: block;}
        .accounts-title { font-weight: 500; margin-bottom: 10px; color: var(--color-text-primary); }

        @media (max-width: 768px) {
            .page-header { flex-direction: column; align-items: flex-start; }
            .vendedor-section-header { flex-direction: column; align-items: stretch;}
            .resumen-table th, .resumen-table td { padding: 0.6rem 0.8rem; white-space: nowrap;}
            .resumen-table { display: block; overflow-x: auto; }
            .vendedor-cards-grid { grid-template-columns: 1fr; }
            .modal-content { max-width: 95%; padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .modal-footer { flex-direction: column-reverse; }
            .modal-footer .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container">
        <div class="vendedor-main-container">
            <div class="vendedor-section-header">
                 <div class="header-title-button">
                    <h2><i class="fas fa-handshake icon-header icon-closer"></i> Gestión de Vendedores</h2>
                    <% if (user && (user.role === 'ventas' || user.role === 'auditoria')) { %>
                        <button class="btn btn-primary" onclick="openCloserModal()">
                            <i class="fas fa-user-plus"></i> Agregar Closer
                        </button>
                        <button class="btn btn-info btn-sm" id="showAllClosersBtn" style="margin-left: 10px;"><i class="fas fa-eye"></i> Mostrar Todos</button>
                    <% } %>
                 </div>
                 <div class="seller-filter-container">
                    <i class="fas fa-search filter-icon"></i>
                    <input type="text" id="closer-name-filter" placeholder="Filtrar por nombre...">
                </div>
            </div>

            <% if (typeof success !== 'undefined' && success) { %><div class="alert alert-success global-feedback" role="alert"><i class="fas fa-check-circle"></i> <%= success %></div><% } %>
            <% if (typeof error !== 'undefined' && error) { %><div class="alert alert-danger global-feedback" role="alert"><i class="fas fa-exclamation-circle"></i> <%= error %></div><% } %>

            <div class="resumen-vendedores-container">
                <div class="resumen-header">
                    <h3><i class="fas fa-list-ol"></i> Resumen de Closers</h3>
                    <button id="toggle-resumen" class="btn btn-sm btn-outline-secondary"><i class="fas fa-chevron-up"></i> Contraer</button>
                </div>
                <div class="resumen-list-container" id="resumen-list">
                    <% if (typeof closers !== 'undefined' && closers.length > 0) { %>
                        <table class="resumen-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Estado</th>
                                    <th>Cuentas</th>
                                    <th class="agendas-col">Agendas Hoy</th>
                                    <th class="agendas-col">Agendas Mes</th>
                                    <th>Objetivo</th>
                                    <th>Progreso</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% closers.forEach(closer => { %>
                                    <tr class="resumen-item" data-closer-id="<%= closer.id %>">
                                        <td class="resumen-nombre">
                                            <span><%= closer.nombre %></span>
                                            <% if (closer.manager_asignado) { %><small><i class="fas fa-user-tie"></i> <%= closer.manager_asignado %></small><% } %>
                                        </td>
                                        <td><span class="tag tag-estado tag-estado-<%= closer.estado %>"><%= closer.estado %></span></td>
                                        <td><%= closer.num_cuentas || 0 %></td>
                                        <td class="agendas-col"><%= closer.agendasHoy || 0 %></td>
                                        <td class="agendas-col"><%= (closer.agendasEsteMes || 0).toLocaleString('es-ES') %></td>
                                        <td><%= (closer.objetivo_mensual || 0).toLocaleString('es-ES') || 'N/A' %></td>
                                        <td>
                                            <div class="mini-progress-container" title="Progreso vs Objetivo Mensual de Agendas">
                                                <div class="mini-progress-bar" style="width: <%= parseFloat(closer.progresoAgendasPct || 0) %>%; background-color: <%= parseFloat(closer.progresoAgendasPct || 0) >= 100 ? 'var(--color-success)' : 'var(--color-info)' %>;"></div>
                                                <span class="mini-progress-text"><%= parseFloat(closer.progresoAgendasPct || 0).toFixed(0) %>%</span>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <p class="no-data-global">No hay Vendedores registrados actualmente.</p>
                    <% } %>
                </div>
            </div>

            <div class="vendedor-cards-grid" id="closer-cards-container" style="display: none;">
                <% if (typeof closers !== 'undefined' && closers.length > 0) { %>
                    <% closers.forEach(closer => { %>
                        <div class="vendedor-card closer-card" id="closer-card-<%= closer.id %>"
                             data-closer='<%- JSON.stringify(closer) %>'
                             data-agendas-hoy="<%= closer.agendasHoy || 0 %>"
                             data-notas-hoy="<%= closer.notasHoy || '' %>">
                            <div class="card-header">
                                 <span class="tag tag-estado tag-estado-<%= closer.estado %>"><%= closer.estado %></span>
                                <h3 class="vendedor-nombre closer-nombre"><%= closer.nombre %></h3>
                                <% if (closer.manager_asignado) { %><small class="manager"><i class="fas fa-user-tie"></i> Manager: <%= closer.manager_asignado %></small><% } %>
                            </div>
                            <div class="card-body">
                                <% if (closer.cuentas_asignadas && closer.cuentas_asignadas.length > 0) { %>
                                    <div class="card-section">
                                        <h4><i class="fas fa-link"></i> Cuentas Asignadas (<%= closer.num_cuentas || 0 %>)</h4>
                                        <ul class="account-list custom-scrollbar">
                                            <% closer.cuentas_asignadas.forEach(cuenta => { %>
                                                <li><span class="tag tag-cuenta"><%= cuenta %></span></li>
                                            <% }); %>
                                        </ul>
                                    </div>
                                <% } %>
                                <div class="card-section card-stats">
                                    <div class="stat-item">
                                        <label><i class="far fa-calendar-check icon-closer"></i> Agendas Hoy</label>
                                        <span class="agendas-col"><%= closer.agendasHoy || 0 %></span>
                                        <% if(closer.notasHoy) { %><small title="Nota de hoy: <%= closer.notasHoy %>"><i class="far fa-comment-dots"></i></small><% } %>
                                    </div>
                                    <div class="stat-item">
                                        <label><i class="fas fa-calendar-alt icon-closer"></i> Agendas Mes</label>
                                        <span class="agendas-col"><%= (closer.agendasEsteMes || 0).toLocaleString('es-ES') %></span>
                                    </div>
                                    <% if (closer.fecha_ingreso) { %><div class="stat-item"><label><i class="far fa-calendar-alt"></i> Ingreso</label><span><%= new Date(closer.fecha_ingreso).toLocaleDateString('es-ES') %></span></div><% } %>

                                    <div class="stat-item stat-progress">
                                        <label><i class="fas fa-tasks icon-closer"></i> Progreso Mes (Agendas)</label>
                                        <div class="progress-info">
                                             <span class="progress-numbers" title="Agendas este mes / Objetivo mensual"><%= (closer.agendasEsteMes || 0).toLocaleString('es-ES') %> / <%= (closer.objetivo_mensual || 0).toLocaleString('es-ES') || 'N/A' %></span>
                                             <span class="progress-percentage">(<%= parseFloat(closer.progresoAgendasPct || 0).toFixed(0) %>%)</span>
                                        </div>
                                        <div class="progress-bar-container" title="<%= parseFloat(closer.progresoAgendasPct || 0).toFixed(1) %>% del objetivo mensual de agendas">
                                            <div class="progress-bar" style="width: <%= parseFloat(closer.progresoAgendasPct || 0) %>%; background-color: var(--color-info);"></div>
                                        </div>
                                    </div>
                                </div>
                                 <% if (user && (user.role === 'ventas' || user.role === 'auditoria')) { %>
                                    <div class="card-section">
                                        <h4><i class="far fa-clipboard"></i> Notas Auditoría</h4>
                                        <p class="notas custom-scrollbar"><%= closer.notas_auditoria || 'Sin notas.' %></p>
                                    </div>
                                <% } %>
                            </div>
                            <div class="card-footer">
                                 <% if (user && (user.role === 'ventas' || user.role === 'auditoria')) { %>
                                    <button class="btn btn-sm btn-secondary" onclick="openAgendasModal('<%= closer.id %>')" title="Registrar agendas diarias"><i class="fas fa-calendar-plus"></i> Registrar Hoy</button>
                                    <button class="btn btn-sm btn-warning" onclick="openCloserModal('<%= closer.id %>')" title="Editar perfil"><i class="fas fa-edit"></i> Editar</button>
                                <% } %>
                                <a href="/closers/<%= closer.id %>/historial" class="btn btn-sm btn-info" title="Ver historial"><i class="fas fa-history"></i> Historial</a>
                            </div>
                        </div>
                     <% }); %>
                 <% } else { %>
                     <p class="no-data-global">No hay Vendedores registrados actualmente.</p>
                 <% } %>
                 <p id="no-closer-found-message" class="no-data-global" style="display: none;">No se encontraron Vendedores que coincidan con el filtro.</p>
            </div>
        </div>
    </div>

    <div id="closerModalOverlay" class="modal-overlay">
         <div class="modal-content" id="closerModalContent">
            <form action="/closers" method="POST" id="closer-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="closerModalLabel">Agregar Vendedor</h5>
                    <button type="button" class="modal-close-btn" onclick="closeCloserModal()" title="Cerrar">×</button>
                </div>
                <div class="modal-body custom-scrollbar">
                    <input type="hidden" id="closer_id" name="closer_id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modal_closer_nombre" class="form-label"><i class="fas fa-user fa-fw"></i> Nombre Closer*</label>
                            <input type="text" class="form-control" id="modal_closer_nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                             <label for="modal_closer_manager" class="form-label"><i class="fas fa-user-tie fa-fw"></i> Manager Asignado</label>
                            <input type="text" class="form-control" id="modal_closer_manager" name="manager_asignado">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="modal_closer_cuentas" class="form-label"><i class="fas fa-link fa-fw"></i> Cuentas Asignadas (opcional, separadas por coma)</label>
                        <input type="text" class="form-control" id="modal_closer_cuentas" name="cuentas_asignadas" placeholder="cuenta_ref1, cuenta_ref2">
                    </div>
                     <div class="form-row">
                         <div class="form-group">
                             <label for="modal_closer_objetivo" class="form-label"><i class="fas fa-bullseye fa-fw icon-closer"></i> Objetivo Mensual (Agendas)</label>
                            <input type="number" class="form-control" id="modal_closer_objetivo" name="objetivo_mensual" min="0" step="1" value="0">
                         </div>
                          <div class="form-group">
                             <label for="modal_closer_estado" class="form-label"><i class="fas fa-toggle-on fa-fw"></i> Estado</label>
                            <select id="modal_closer_estado" name="estado" class="form-control">
                                <option value="activo" selected>Activo</option>
                                <option value="inactivo">Inactivo</option>
                                <option value="baja">De Baja</option>
                            </select>
                         </div>
                    </div>
                     <div class="form-row">
                         <div class="form-group">
                             <label for="modal_closer_fecha_ingreso" class="form-label"><i class="far fa-calendar-alt fa-fw"></i> Fecha Ingreso</label>
                            <input type="date" class="form-control" id="modal_closer_fecha_ingreso" name="fecha_ingreso">
                         </div>
                    </div>
                    <div class="form-group">
                        <label for="modal_closer_notas" class="form-label"><i class="far fa-clipboard fa-fw"></i> Notas / Comentarios (Auditoría)</label>
                        <textarea id="modal_closer_notas" name="notas_auditoria" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCloserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Closer</button>
                </div>
            </form>
        </div>
    </div>

     <div id="agendasModalOverlay" class="modal-overlay">
         <div class="modal-content" id="agendasModalContent">
            <form id="agendas-form" onsubmit="submitAgendas(event)">
                <div class="modal-header">
                    <h5 class="modal-title" id="agendasModalLabel">Registrar Agendas Diarias</h5>
                     <button type="button" class="modal-close-btn" onclick="closeAgendasModal()" title="Cerrar">×</button>
                </div>
                <div class="modal-body custom-scrollbar">
                    <input type="hidden" id="agendas_closer_id" name="closer_id">
                    <div class="form-group">
                        <label for="agendas_fecha" class="form-label"><i class="far fa-calendar-alt fa-fw"></i> Fecha del Registro</label>
                        <input type="date" class="form-control" id="agendas_fecha" name="fecha" value="<%= typeof today !== 'undefined' ? today : new Date().toISOString().slice(0,10) %>" required>
                    </div>
                    <div class="form-group">
                         <label for="agendas_registradas" class="form-label"><i class="fas fa-calendar-check fa-fw icon-closer"></i> Agendas Registradas Hoy*</label>
                        <input type="number" class="form-control" id="agendas_registradas" name="agendas_registradas" min="0" step="1" value="0" required>
                    </div>
                     <div class="form-group">
                        <label for="agendas_notas" class="form-label"><i class="far fa-comment-dots fa-fw"></i> Notas (Opcional)</label>
                        <textarea class="form-control" id="agendas_notas" name="notas" rows="3"></textarea>
                    </div>
                    <div id="agendas-feedback" class="feedback-message"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAgendasModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-check-circle"></i> Guardar Agendas</button>
                </div>
            </form>
        </div>
    </div>

    <script defer src="/static/js/navbar.js"></script>
    <script>
        // Funciones para manejar los modales
        function openCloserModal(closerIdToEdit = null) {
            const closerForm = document.getElementById('closer-form');
            const closerModalLabel = document.getElementById('closerModalLabel');
            const closerIdInput = document.getElementById('closer_id');
            
            closerForm.reset();
            closerIdInput.value = '';
            
            if (closerIdToEdit) {
                closerModalLabel.textContent = 'Editar Closer';
                const card = document.getElementById(`closer-card-${closerIdToEdit}`);
                
                if (card) {
                    try {
                        const closerData = JSON.parse(card.getAttribute('data-closer'));
                        closerIdInput.value = closerData.id;
                        document.getElementById('modal_closer_nombre').value = closerData.nombre || '';
                        document.getElementById('modal_closer_cuentas').value = Array.isArray(closerData.cuentas_asignadas) ? 
                            closerData.cuentas_asignadas.join(', ') : '';
                        document.getElementById('modal_closer_estado').value = closerData.estado || 'activo';
                        document.getElementById('modal_closer_objetivo').value = closerData.objetivo_mensual || 0;
                        document.getElementById('modal_closer_manager').value = closerData.manager_asignado || '';
                        
                        if (closerData.fecha_ingreso) {
                            document.getElementById('modal_closer_fecha_ingreso').value = 
                                new Date(closerData.fecha_ingreso).toISOString().split('T')[0];
                        }
                        
                        document.getElementById('modal_closer_notas').value = closerData.notas_auditoria || '';
                    } catch (e) { 
                        console.error("Error parsing closer data:", e); 
                        alert("Error al cargar datos."); 
                        return; 
                    }
                } else { 
                    alert("No se encontró info para editar."); 
                    return; 
                }
            } else { 
                closerModalLabel.textContent = 'Agregar Closer'; 
            }
            
            document.getElementById('closerModalOverlay').style.display = 'flex';
        }

        function closeCloserModal() { 
            document.getElementById('closerModalOverlay').style.display = 'none'; 
        }

        function openAgendasModal(closerId) {
            const agendasForm = document.getElementById('agendas-form');
            const agendasFeedbackDiv = document.getElementById('agendas-feedback');
            
            agendasForm.reset();
            agendasFeedbackDiv.textContent = '';
            agendasFeedbackDiv.className = 'feedback-message';
            
            document.getElementById('agendas_closer_id').value = closerId;
            const closerCard = document.getElementById(`closer-card-${closerId}`);
            const closerName = closerCard ? closerCard.querySelector('.closer-nombre').textContent : `ID ${closerId}`;
            
            document.getElementById('agendasModalLabel').textContent = `Registrar Agendas - ${closerName}`;
            document.getElementById('agendas_fecha').value = new Date().toISOString().slice(0, 10);
            
            if (closerCard) {
                document.getElementById('agendas_registradas').value = parseInt(closerCard.getAttribute('data-agendas-hoy') || '0', 10);
                document.getElementById('agendas_notas').value = closerCard.getAttribute('data-notas-hoy') || '';
            }
            
            document.getElementById('agendasModalOverlay').style.display = 'flex';
        }

        function closeAgendasModal() { 
            document.getElementById('agendasModalOverlay').style.display = 'none'; 
        }

        async function submitAgendas(event) {
            event.preventDefault();
            const agendasFeedbackDiv = document.getElementById('agendas-feedback');
            const agendasCloserIdInput = document.getElementById('agendas_closer_id');
            const agendasFechaInput = document.getElementById('agendas_fecha');
            const agendasRegistradasInput = document.getElementById('agendas_registradas');
            const agendasNotasInput = document.getElementById('agendas_notas');
            
            agendasFeedbackDiv.textContent = 'Guardando...';
            agendasFeedbackDiv.className = 'feedback-message info';
            const formData = {
                closer_id: agendasCloserIdInput.value, 
                fecha: agendasFechaInput.value,
                agendas_registradas: agendasRegistradasInput.value, 
                notas: agendasNotasInput.value
            };
            
            try {
                const response = await fetch('/closers/agendas', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    agendasFeedbackDiv.textContent = result.message; 
                    agendasFeedbackDiv.className = 'feedback-message success';
                    setTimeout(() => { 
                        closeAgendasModal(); 
                        window.location.reload(); 
                    }, 1200);
                } else { 
                    throw new Error(result.message || 'Error desconocido'); 
                }
            } catch (error) {
                console.error("Error al guardar agendas:", error);
                agendasFeedbackDiv.textContent = `Error: ${error.message}`;
                agendasFeedbackDiv.className = 'feedback-message error';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para cerrar modales al hacer clic fuera o presionar ESC
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('closerModalOverlay')) {
                    closeCloserModal();
                }
                if (event.target === document.getElementById('agendasModalOverlay')) {
                    closeAgendasModal();
                }
            });

            window.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    if(document.getElementById('closerModalOverlay').style.display === 'flex') {
                        closeCloserModal();
                    }
                    if(document.getElementById('agendasModalOverlay').style.display === 'flex') {
                        closeAgendasModal();
                    }
                }
            });

            // Filtro de closers
            const closerFilterInput = document.getElementById('closer-name-filter');
            const closerCardsContainer = document.getElementById('closer-cards-container');
            const noCloserFoundMessage = document.getElementById('no-closer-found-message');
            const resumenTableBody = document.querySelector('.resumen-table tbody');

            if (closerFilterInput && (closerCardsContainer || resumenTableBody)) {
                closerFilterInput.addEventListener('input', function() {
                    const filterValue = this.value.toLowerCase().trim();
                    let visibleCount = 0; 
                    let totalCount = 0;
                    
                    if(closerCardsContainer) {
                        const cards = closerCardsContainer.querySelectorAll('.closer-card');
                        totalCount = cards.length;
                        cards.forEach(card => {
                            const nombre = card.querySelector('.closer-nombre')?.textContent.toLowerCase() || '';
                            const isVisible = !filterValue || nombre.includes(filterValue);
                            card.style.display = isVisible ? '' : 'none';
                            if(isVisible) visibleCount++;
                        });
                    }
                    
                    if(resumenTableBody) {
                        const rows = resumenTableBody.querySelectorAll('.resumen-item');
                        if(totalCount === 0) totalCount = rows.length;
                        rows.forEach(row => {
                            const nombre = row.querySelector('.resumen-nombre span')?.textContent.toLowerCase() || '';
                            const isVisible = !filterValue || nombre.includes(filterValue);
                            row.style.display = isVisible ? '' : 'none';
                            if (!closerCardsContainer || filterValue) {
                                if(isVisible && visibleCount === 0) visibleCount++;
                            }
                        });
                    }
                    
                    if (noCloserFoundMessage) {
                        noCloserFoundMessage.style.display = (visibleCount === 0 && totalCount > 0) ? 'block' : 'none';
                    }
                });
            }

            // Toggle para contraer/expandir resumen
            const toggleBtn = document.getElementById('toggle-resumen');
            const resumenList = document.getElementById('resumen-list');
            const cardsContainer = document.getElementById('closer-cards-container');
            const showAllBtn = document.getElementById('showAllClosersBtn');

            if (toggleBtn && resumenList && cardsContainer) {
                toggleBtn.addEventListener('click', function() {
                    const isCollapsed = resumenList.classList.toggle('collapsed');
                    const icon = this.querySelector('i');
                    icon.classList.toggle('fa-chevron-up', !isCollapsed);
                    icon.classList.toggle('fa-chevron-down', isCollapsed);
                    this.childNodes[1].nodeValue = isCollapsed ? ' Expandir' : ' Contraer';
                });

                document.querySelectorAll('.resumen-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const closerId = this.getAttribute('data-closer-id');
                        cardsContainer.style.display = 'grid';
                        let foundCard = false;
                        document.querySelectorAll('.closer-card').forEach(card => {
                            if(card.id === `closer-card-${closerId}`) {
                                card.style.display = 'block';
                                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                card.classList.add('highlighted');
                                setTimeout(() => card.classList.remove('highlighted'), 1500);
                                foundCard = true;
                            } else {
                                card.style.display = 'none';
                            }
                        });
                        
                        if (noCloserFoundMessage) noCloserFoundMessage.style.display = 'none';
                        if (closerFilterInput) closerFilterInput.value = '';
                    });
                });

                if (showAllBtn) {
                    showAllBtn.addEventListener('click', function() {
                        cardsContainer.style.display = 'grid';
                        let hasCards = false;
                        document.querySelectorAll('.closer-card').forEach(card => {
                            card.style.display = 'block';
                            hasCards = true;
                        });
                        
                        if(closerFilterInput) closerFilterInput.value = '';
                        if(noCloserFoundMessage) noCloserFoundMessage.style.display = 'none';
                        
                        if(!hasCards && noCloserFoundMessage) {
                            noCloserFoundMessage.textContent = "No hay Closers registrados.";
                            noCloserFoundMessage.style.display = 'block';
                        }
                    });
                }
            }
        });
    </script>
        <script defer src="/static/js/vendedores_manager.js"></script>

</body>
</html>