<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HUNTER - Panel de Fulfillment</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome (SOLO CSS CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Estilos Base -->
    <link rel="stylesheet" href="/static/css/navbar.css" />
    <link rel="stylesheet" href="/static/css/onboarding.css" /> <!-- Para variables y estilos base -->
    <link rel="stylesheet" href="/static/css/scrollbar.css" />
    <!-- CSS FullCalendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />

    <!-- Estilos para esta página específica -->
    <style>
        /* =========================================== */
        /*     COPIAR TODO EL BLOQUE <STYLE> AQUÍ     */
        /*     (Incluyendo estilos base, layout,     */
        /*      menu, calendario, modal,              */
        /*      FullCalendar overrides, responsividad) */
        /* =========================================== */

        /* --- Ejemplo Corto (Reemplazar con tus estilos completos) --- */
         body { font-family: var(--font-primary, 'Poppins', sans-serif); background-color: var(--color-background-dark, #0a0a10); color: var(--color-text-primary, #e5e7eb); line-height: var(--line-height-base, 1.7); }
         body::-webkit-scrollbar { width: 8px; } body::-webkit-scrollbar-track { background: var(--color-background-medium, #111827); } body::-webkit-scrollbar-thumb { background-color: var(--color-accent, #4caf91); border-radius: 10px; border: 2px solid var(--color-background-medium, #111827); } body::-webkit-scrollbar-thumb:hover { background-color: var(--color-accent-hover, #5cdb95); }
         .fulfillment-container { padding: 2.5rem 1rem; max-width: 1400px; margin: 1.5rem auto; }
         .fulfillment-header { text-align: center; margin-bottom: 2rem; }
         .fulfillment-header h1 { font-size: 2.5rem; font-weight: 600; margin-bottom: 0.8rem; color: var(--color-text-primary, #e5e7eb); }
         .fulfillment-header h1 .highlight { color: var(--color-highlight, #4caf91); }
         .fulfillment-header p { font-size: 1.1rem; color: var(--color-text-secondary, #9ca3af); max-width: 700px; margin: 0 auto; }
         .fulfillment-content { display: grid; grid-template-columns: 300px 1fr; gap: 2.5rem; align-items: start; }
         .fulfillment-menu { background: linear-gradient(145deg, var(--color-background-medium, #111827), var(--color-background-light, #1f2937)); border-radius: var(--border-radius-large, 16px); padding: 2rem 1.5rem; border: 1px solid var(--color-border, rgba(76, 175, 145, 0.2)); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); position: sticky; top: 80px; }
         .fulfillment-menu h2 { font-size: 1.4rem; color: var(--color-accent-hover, #5cdb95); margin-bottom: 1.5rem; padding-bottom: 0.8rem; border-bottom: 1px solid var(--color-border, rgba(76, 175, 145, 0.2)); text-align: center; }
         .menu-options { display: flex; flex-direction: column; gap: 1.5rem; }
         .menu-button { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.2rem; background-color: rgba(255, 255, 255, 0.05); color: var(--color-text-primary, #e5e7eb); text-decoration: none; border-radius: var(--border-radius-medium, 8px); font-size: 1.1rem; font-weight: 500; transition: all 0.3s ease; border: 1px solid transparent; border-left: 4px solid transparent; }
         .menu-button i { font-size: 1.4rem; width: 25px; text-align: center; color: var(--color-accent, #4caf91); transition: color 0.3s ease; }
         .menu-button:hover { background-color: rgba(76, 175, 145, 0.15); border-left-color: var(--color-accent-hover, #5cdb95); transform: translateX(5px); color: var(--color-accent-hover, #5cdb95); }
         .menu-button:hover i { color: var(--color-accent-hover, #5cdb95); }
         .calendar-section { background: linear-gradient(145deg, var(--color-background-medium, #111827), var(--color-background-light, #1f2937)); border-radius: var(--border-radius-large, 16px); padding: 2.5rem; border: 1px solid var(--color-border, rgba(76, 175, 145, 0.2)); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); min-height: 600px; }
         .calendar-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--color-border, rgba(76, 175, 145, 0.2)); }
         .calendar-header h2 { font-size: 1.6rem; color: var(--color-accent-hover, #5cdb95); margin: 0; }
         .calendar-actions button { margin-left: 0.8rem; padding: 0.6rem 1.2rem; background-color: var(--color-accent, #4caf91); color: var(--color-background-dark, #0a0a10); border: none; border-radius: var(--border-radius-medium, 8px); font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
         .calendar-actions button:hover { background-color: var(--color-accent-hover, #5cdb95); transform: translateY(-2px); box-shadow: 0 5px 10px rgba(76, 175, 145, 0.4); }
         .calendar-actions button i { margin-right: 0.5rem; }
         #fulfillment-calendar { width: 100%; height: auto; }
         /* Estilos FullCalendar */
         :root { --fc-border-color: var(--color-border, rgba(76, 175, 145, 0.25)); /* ... resto variables fc ... */ }
         .fc { color: var(--color-text-primary, #e5e7eb); background-color: transparent; }
         /* ... (PEGAR AQUÍ TODOS LOS ESTILOS .fc , modal, responsividad, etc.) ... */
         .event-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1050; opacity: 0; transition: opacity 0.3s ease; }
         .event-modal-overlay.active { display: flex; opacity: 1; }
         .event-modal-content { background: linear-gradient(145deg, var(--color-background-medium, #111827), var(--color-background-light, #1f2937)); border-radius: var(--border-radius-large, 16px); padding: 0; border: 1px solid var(--color-border, rgba(76, 175, 145, 0.2)); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6); width: 90%; max-width: 550px; display: flex; flex-direction: column; max-height: 85vh; overflow: hidden; transform: scale(0.95); transition: transform 0.3s ease; }
         .event-modal-overlay.active .event-modal-content { transform: scale(1); }
         .event-modal-header, .event-modal-footer { padding: 1.2rem 1.5rem; background-color: rgba(0,0,0, 0.15); display: flex; justify-content: space-between; align-items: center; }
         .event-modal-header { border-bottom: 1px solid var(--color-border); border-radius: 16px 16px 0 0;}
         .event-modal-footer { border-top: 1px solid var(--color-border); border-radius: 0 0 16px 16px; gap: 1rem;}
         .event-modal-title { font-size: 1.4rem; color: var(--color-accent-hover); margin: 0; font-weight: 600;}
         .event-modal-close-btn { background: none; border: none; color: var(--color-text-secondary); font-size: 1.8rem; cursor: pointer; padding: 0; line-height: 1; }
         .event-modal-close-btn:hover { color: var(--color-accent-hover); }
         .event-modal-body { padding: 1.8rem 1.5rem; flex-grow: 1; overflow-y: auto; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-accent) rgba(255, 255, 255, 0.08); }
         .event-modal-body::-webkit-scrollbar { width: 8px; } .event-modal-body::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; } .event-modal-body::-webkit-scrollbar-thumb { background-color: var(--color-accent); border-radius: 4px; border: 1px solid var(--color-background-light); } .event-modal-body::-webkit-scrollbar-thumb:hover { background-color: var(--color-accent-hover); }
         .event-modal-body .form-group { margin-bottom: 1.2rem; }
         .event-modal-body label { display: block; font-weight: 500; color: var(--color-text-secondary, #9ca3af); margin-bottom: 0.5rem; font-size: 0.9rem; }
         .event-modal-body input[type="text"], .event-modal-body input[type="date"], .event-modal-body textarea { width: 100%; padding: 0.8rem 1rem; background-color: rgba(0, 0, 0, 0.2); border: 1px solid var(--color-border, rgba(76, 175, 145, 0.2)); border-radius: var(--border-radius-medium, 8px); color: var(--color-text-primary, #e5e7eb); font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
         .event-modal-body input:focus, .event-modal-body textarea:focus { outline: none; border-color: var(--color-accent, #4caf91); box-shadow: 0 0 0 3px rgba(76, 175, 145, 0.3); }
         .event-modal-body textarea { resize: vertical; min-height: 80px;}
         .event-modal-footer .btn { padding: 0.7rem 1.5rem; font-size: 0.95rem; font-weight: 600; border-radius: var(--border-radius-medium, 8px); border: none; cursor: pointer; transition: all 0.2s ease; }
         .event-modal-footer .btn-secondary { background-color: var(--color-background-light, #1f2937); color: var(--color-text-secondary, #9ca3af); border: 1px solid var(--color-border, rgba(76, 175, 145, 0.2)); }
         .event-modal-footer .btn-secondary:hover { background-color: var(--color-background-medium, #111827); color: var(--color-text-primary, #e5e7eb); border-color: var(--color-text-secondary, #9ca3af); }
         .event-modal-footer .btn-primary { background: linear-gradient(145deg, var(--color-accent, #4caf91), var(--color-accent-hover, #5cdb95)); color: var(--color-background-dark, #0a0a10); box-shadow: 0 3px 8px rgba(76, 175, 145, 0.25); }
         .event-modal-footer .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 12px rgba(76, 175, 145, 0.4); }
         .event-modal-footer .btn-danger { background-color: #dc3545; color: white; } .event-modal-footer .btn-danger:hover { background-color: #c82333; }
         .event-modal-footer .btn:disabled { opacity: 0.6; cursor: not-allowed; }
         .event-modal-footer .btn .fa-spinner { margin-right: 0.5rem; }
         /* Responsividad */
         @media (max-width: 992px) { .fulfillment-content { grid-template-columns: 250px 1fr; gap: 2rem; } } @media (max-width: 768px) { .fulfillment-content { grid-template-columns: 1fr; } .fulfillment-menu { position: static; margin-bottom: 2rem; } .calendar-section { padding: 1.5rem; } .calendar-header { flex-direction: column; gap: 1rem; align-items: stretch; text-align: center; } .calendar-actions { display: flex; justify-content: center; gap: 0.8rem;} .fc .fc-toolbar.fc-header-toolbar { flex-direction: column; gap: 1rem; } } @media (max-width: 480px) { .event-modal-footer { flex-direction: column-reverse; } .event-modal-footer .btn { width: 100%; } .event-modal-footer .btn-danger { margin-right: 0 !important; margin-bottom: 0.5rem;} }

    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="onboarding-background">
        <div class="fulfillment-container">

            <header class="fulfillment-header">
              <h1>Panel de <span class="highlight">Fulfillment</span></h1>
              <p>Gestiona tu flujo de trabajo, organiza eventos y supervisa las actividades clave.</p>
              <!-- Mostrar mensajes flash/info si existen -->
              <% if (locals.message || locals.info_msg) { %><p style="margin-top: 1rem; color: var(--color-text-secondary); font-style: italic;"><%= locals.message || locals.info_msg %></p><% } %>
              <% if (locals.error_msg) { %><p style="margin-top: 1rem; color: #f87171; font-weight: 500;"><%= error_msg %></p><% } %>
            </header>

            <div class="fulfillment-content">
                <!-- Menú Lateral -->
                <aside class="fulfillment-menu">
                    <h2>Navegación</h2>
                    <nav class="menu-options">
                        <a href="/dashboard" class="menu-button"><i class="fas fa-tachometer-alt fa-fw"></i><span>Dashboard</span></a>
                        <a href="#fulfillment-calendar" class="menu-button" onclick="document.getElementById('fulfillment-calendar').scrollIntoView({ behavior: 'smooth' });"><i class="fas fa-calendar-alt fa-fw"></i><span>Calendario</span></a>
                        <a href="/actividades-clientes" class="menu-button"><i class="fas fa-users fa-fw"></i><span>Actividades Clientes</span></a>
                    </nav>
                </aside>

                <!-- Calendario -->
                <section class="calendar-section">
                    <div class="calendar-header">
                         <h2>Calendario de Eventos</h2>
                         <div class="calendar-actions">
                             <button id="add-event-btn"><i class="fas fa-plus"></i> Nuevo Evento</button>
                             <button id="export-calendar-btn" title="Exportar vista actual como imagen"><i class="fas fa-camera"></i> Exportar Imagen</button>
                         </div>
                    </div>
                    <div id="fulfillment-calendar">
                       <!-- Mensaje de carga/error se manejará por JS -->
                       <p style="text-align: center; padding: 3rem 0; color: var(--color-text-secondary);">Cargando calendario...</p>
                    </div>
                </section>
            </div>

        </div> <!-- Fin .fulfillment-container -->
    </div> <!-- Fin .onboarding-background -->

    <!-- Modal Agregar/Editar Evento -->
    <div id="eventModalOverlay" class="event-modal-overlay">
         <div class="event-modal-content">
            <div class="event-modal-header">
                <h5 class="event-modal-title" id="eventModalLabel">Agregar Nuevo Evento</h5>
                <button type="button" class="event-modal-close-btn" onclick="closeEventModal()" title="Cerrar">×</button>
            </div>
            <div class="event-modal-body custom-scrollbar">
                <form id="event-form">
                    <input type="hidden" id="event_id" name="event_id">
                    <div class="form-group">
                        <label for="event_title">Título del Evento*</label>
                        <input type="text" id="event_title" name="title" required class="form-control"> <!-- Añadir clase form-control -->
                    </div>
                    <div class="form-group">
                         <label for="event_start_date">Fecha Inicio*</label>
                         <input type="date" id="event_start_date" name="start_date" required class="form-control"> <!-- Añadir clase form-control -->
                    </div>
                    <div class="form-group">
                         <label for="event_end_date">Fecha Fin (Opcional)</label>
                         <input type="date" id="event_end_date" name="end_date" class="form-control"> <!-- Añadir clase form-control -->
                     </div>
                    <div class="form-group">
                        <label for="event_description">Descripción</label>
                        <textarea id="event_description" name="description" rows="3" class="form-control"></textarea> <!-- Añadir clase form-control -->
                    </div>
                    <!-- Puedes añadir aquí un input para color si quieres:
                    <div class="form-group">
                        <label for="event_color">Color</label>
                        <input type="color" id="event_color" name="color" value="#4caf91">
                    </div>
                     -->
                </form>
            </div>
            <div class="event-modal-footer">
                 <!-- Botón borrar se añade dinámicamente aquí -->
                <button type="button" class="btn btn-secondary" onclick="closeEventModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEvent()">Guardar Evento</button>
            </div>
         </div>
    </div>


    <!-- ============================================= -->
    <!--                 SCRIPTS AL FINAL              -->
    <!-- ============================================= -->

    <!-- Cargar librerías EXTERNAS ANTES de tu script personalizado -->
    <!-- Usar 'defer' para asegurar ejecución ordenada después del parseo HTML -->
    <script defer src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js'></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script defer src="/static/js/navbar.js"></script>


    <!-- Tu Script Personalizado -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // VERIFICACIÓN DE LIBRERÍAS
            if (typeof FullCalendar === 'undefined') {
                console.error("Error: FullCalendar library not loaded.");
                document.getElementById('fulfillment-calendar').innerHTML = '<div style="color: #f87171; text-align: center; padding: 2rem; border: 1px dashed #f87171; border-radius: 8px; background-color: rgba(239, 68, 68, 0.1);"><p><i class="fas fa-exclamation-triangle fa-2x"></i></p><p style="margin-top: 1rem; font-weight: 500;">Error crítico: La librería del calendario (FullCalendar) no pudo cargarse.</p><p style="font-size: 0.9rem; opacity: 0.8;">Revisa la consola (F12) y la conexión a internet.</p></div>';
                return;
            }
            if (typeof html2canvas === 'undefined') {
                 console.warn("Advertencia: html2canvas library not loaded. La exportación no funcionará."); // Cambiado a warn
                 const exportBtn = document.getElementById('export-calendar-btn');
                 if(exportBtn) { exportBtn.disabled = true; exportBtn.title = "Librería de exportación no disponible."; }
            }

            // CONSTANTES Y VARIABLES
            const calendarEl = document.getElementById('fulfillment-calendar');
            const modalOverlay = document.getElementById('eventModalOverlay');
            const eventForm = document.getElementById('event-form');
            const eventModalLabel = document.getElementById('eventModalLabel');
            const eventIdInput = document.getElementById('event_id');
            const eventTitleInput = document.getElementById('event_title');
            const eventStartDateInput = document.getElementById('event_start_date');
            const eventEndDateInput = document.getElementById('event_end_date');
            const eventDescriptionInput = document.getElementById('event_description');
            let calendar;

             // INICIALIZACIÓN FULLCALENDAR
             function initializeCalendar(initialEvents = []) {
                if (calendar) { calendar.destroy(); }
                const formattedEvents = initialEvents.map(event => ({ id: String(event.id), title: event.title, start: event.start, end: event.end, allDay: event.all_day, color: event.color || '#4caf91', extendedProps: { description: event.description } })); // Asegurar ID es string y color default
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth', headerToolbar: {left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek'}, locale: 'es', buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', list: 'Lista'}, editable: true, selectable: true, events: formattedEvents, height: 'auto', contentHeight: 600, eventColor: '#4caf91',
                    select: function(info) { openEventModal(null, info.startStr, info.endStr, info.allDay); },
                    eventClick: function(info) { openEventModal(info.event); info.jsEvent.preventDefault(); },
                    eventDrop: function(info) { console.log(`${info.event.title} movido a ${info.event.startStr}`); if (!confirm(`¿Confirmar nueva fecha para '${info.event.title}'?`)) { info.revert(); } else { updateEvent({ id: info.event.id, start: info.event.startStr, end: info.event.endStr, allDay: info.event.allDay }, info.revert); }}, // Enviar solo lo que cambia
                    eventResize: function(info) { console.log(`${info.event.title} redim. fin: ${info.event.endStr}`); if (!confirm(`¿Confirmar nuevo tamaño para '${info.event.title}'?`)) { info.revert(); } else { updateEvent({ id: info.event.id, start: info.event.startStr, end: info.event.endStr, allDay: info.event.allDay }, info.revert); }}, // Enviar solo lo que cambia
                    eventDidMount: function(info) { if (info.event.extendedProps.description) { info.el.setAttribute('title', info.event.extendedProps.description); } }
                 });
                 calendar.render();
             }

             // MANEJO DEL MODAL
             window.openEventModal = function(event = null, startDateStr = '', endDateStr = '', isAllDaySelection = true) {
                 eventForm.reset();
                 if (event) { /* Modo Edición */
                     eventModalLabel.innerText = 'Editar Evento'; eventIdInput.value = event.id; eventTitleInput.value = event.title || ''; eventStartDateInput.value = event.start ? event.startStr.split('T')[0] : '';
                     // Para la fecha fin, FullCalendar a veces la devuelve un día después para eventos all-day
                     let displayEndDate = '';
                     if (event.end) {
                         if (event.allDay) {
                             let tempEndDate = new Date(event.endStr);
                             tempEndDate.setDate(tempEndDate.getDate() - 1); // Restar un día para mostrar la fecha correcta del último día
                             if(tempEndDate >= new Date(event.startStr)) { // Asegurarse que no sea menor que el inicio
                                 displayEndDate = tempEndDate.toISOString().split('T')[0];
                             }
                         } else {
                            displayEndDate = event.endStr.split('T')[0]; // Si no es allDay, usarla tal cual
                         }
                     }
                     eventEndDateInput.value = displayEndDate;
                     eventDescriptionInput.value = event.extendedProps?.description || '';
                     addDeleteButtonIfNeeded(true, event.id);
                 } else { /* Modo Creación */
                     eventModalLabel.innerText = 'Agregar Evento'; eventIdInput.value = ''; eventStartDateInput.value = startDateStr ? startDateStr.split('T')[0] : ''; eventEndDateInput.value = '';
                     if (endDateStr) { let actualEndDate = new Date(endDateStr); if (isAllDaySelection) actualEndDate.setDate(actualEndDate.getDate() - 1); if (!isAllDaySelection || actualEndDate.toISOString().split('T')[0] !== startDateStr.split('T')[0]) { eventEndDateInput.value = actualEndDate.toISOString().split('T')[0]; }}
                     eventDescriptionInput.value = ''; addDeleteButtonIfNeeded(false);
                 }
                 modalOverlay.classList.add('active'); eventTitleInput.focus();
              }
             window.closeEventModal = function() { modalOverlay.classList.remove('active'); }
             modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeEventModal(); });
             document.getElementById('add-event-btn').addEventListener('click', () => openEventModal());

             // AÑADIR/QUITAR BOTÓN BORRAR
             function addDeleteButtonIfNeeded(show, eventId = null) {
                  const footer = document.querySelector('#eventModalOverlay .event-modal-footer'); let deleteBtn = footer.querySelector('.btn-danger'); if (show && eventId) { if (!deleteBtn) { deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'btn btn-danger'; deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Borrar'; deleteBtn.style.marginRight = 'auto'; deleteBtn.onclick = () => deleteEvent(eventId); footer.insertBefore(deleteBtn, footer.firstChild); } deleteBtn.onclick = () => deleteEvent(eventId); /* Reasignar por si acaso */ } else { if (deleteBtn) { deleteBtn.remove(); } }
              }

             // LLAMADAS API
             async function fetchApi(url, options = {}) {
                 try { const response = await fetch(url, { headers: { 'Content-Type': 'application/json', ...options.headers, }, ...options, }); if (!response.ok) { const errorData = await response.json().catch(() => ({ error: `Error ${response.status}` })); throw new Error(errorData.error || `Error HTTP ${response.status}`); } if (response.status === 204) { return { success: true, deletedEventId: options.method === 'DELETE' ? url.split('/').pop() : undefined }; } return await response.json(); } catch (error) { console.error(`Error fetch ${options.method || 'GET'} ${url}:`, error); throw error; }
              }
             window.saveEvent = async function() {
                   const eventId = eventIdInput.value; const isUpdate = !!eventId; const url = isUpdate ? `/api/calendar/events/${eventId}` : '/api/calendar/events'; const method = isUpdate ? 'PUT' : 'POST';
                   const startDate = eventStartDateInput.value; const endDate = eventEndDateInput.value;
                   const eventData = { title: eventTitleInput.value.trim(), start: startDate, end: endDate || null, description: eventDescriptionInput.value.trim() || null, allDay: !endDate || endDate === startDate };
                   if (!eventData.title || !eventData.start) { alert('Título y Fecha Inicio obligatorios.'); return; }
                   const saveButton = document.querySelector('#eventModalOverlay .btn-primary'); saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...'; try { const result = await fetchApi(url, { method: method, body: JSON.stringify(eventData) }); console.log(`Evento ${isUpdate ? 'actualizado' : 'creado'}:`, result.event); if (isUpdate) { const existingEvent = calendar.getEventById(String(eventId)); if (existingEvent) { existingEvent.setProp('title', result.event.title); existingEvent.setStart(result.event.start); existingEvent.setEnd(result.event.end); existingEvent.setAllDay(result.event.all_day); existingEvent.setProp('color', result.event.color); existingEvent.setExtendedProp('description', result.event.description); } else { calendar.addEvent(mapApiEventToFc(result.event)); } } else { calendar.addEvent(mapApiEventToFc(result.event)); } closeEventModal(); } catch (error) { alert(`Error al guardar evento: ${error.message}`); } finally { saveButton.disabled = false; saveButton.innerHTML = 'Guardar Evento'; }
             }
             async function updateEvent(eventData, revertFunc) {
                 const url = `/api/calendar/events/${eventData.id}`; try { await fetchApi(url, { method: 'PUT', body: JSON.stringify({ start: eventData.start, end: eventData.end, allDay: eventData.allDay }) }); console.log(`Evento ${eventData.id} movido/redim. guardado.`); } catch (error) { alert(`Error al actualizar fecha/hora: ${error.message}`); if (revertFunc) revertFunc(); }
              }
             async function deleteEvent(eventId) {
                   if (!confirm("¿Estás seguro de que quieres borrar este evento?")) return; const url = `/api/calendar/events/${eventId}`; const deleteButton = document.querySelector('#eventModalOverlay .btn-danger'); if (deleteButton) { deleteButton.disabled = true; deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Borrando...'; } try { const result = await fetchApi(url, { method: 'DELETE' }); console.log(`Evento ${eventId} borrado.`); const eventToRemove = calendar.getEventById(String(eventId)); if (eventToRemove) eventToRemove.remove(); closeEventModal(); } catch (error) { alert(`Error al borrar evento: ${error.message}`); if (deleteButton) { deleteButton.disabled = false; deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> Borrar'; } }
              }
             function mapApiEventToFc(apiEvent) {
                   return { id: String(apiEvent.id), title: apiEvent.title, start: apiEvent.start, end: apiEvent.end, allDay: apiEvent.all_day, color: apiEvent.color || '#4caf91', extendedProps: { description: apiEvent.description } }; // Asegurar ID es string y color default
              }

             // EXPORTAR IMAGEN
             document.getElementById('export-calendar-btn').addEventListener('click', function() {
                   if (typeof html2canvas === 'undefined') { alert("La función de exportar no está disponible."); return; }
                   const calendarElement = document.getElementById('fulfillment-calendar'); const containerElement = document.querySelector('.calendar-section'); if (!calendarElement || !containerElement) return; console.log('Iniciando exportación...'); this.disabled = true; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exportando...'; const backgroundColor = window.getComputedStyle(containerElement).backgroundColor; html2canvas(calendarElement, { backgroundColor: backgroundColor || '#111827', scale: window.devicePixelRatio || 2, useCORS: true, logging: false, allowTaint: true, removeContainer: true }).then(canvas => { console.log('Canvas generado.'); const image = canvas.toDataURL('image/png'); const link = document.createElement('a'); link.href = image; link.download = `calendario_fulfillment_${new Date().toISOString().split('T')[0]}.png`; link.click(); console.log('Descarga iniciada.'); }).catch(err => { console.error('Error exportando:', err); alert('Error al generar imagen.'); }).finally(() => { this.disabled = false; this.innerHTML = '<i class="fas fa-camera"></i> Exportar Imagen'; });
              });

             // CARGA INICIAL
             async function loadInitialEvents() {
                  try { const events = await fetchApi('/api/calendar/events'); console.log('Eventos iniciales cargados:', events); initializeCalendar(events); } catch (error) { console.error('Error fatal cargando eventos iniciales:', error); calendarEl.innerHTML = `<div style="color: #f87171; text-align: center; padding: 2rem; border: 1px dashed #f87171; border-radius: 8px; background-color: rgba(239, 68, 68, 0.1);"><p><i class="fas fa-exclamation-triangle fa-2x"></i></p><p style="margin-top: 1rem; font-weight: 500;">Error al cargar datos del calendario</p><p style="font-size: 0.9rem; opacity: 0.8;">${error.message}. Revisa la consola (F12).</p></div>`; }
             }
             loadInitialEvents();

        });
    </script>

</body>
</html>